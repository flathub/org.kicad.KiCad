app-id: org.kicad.KiCad
runtime: org.freedesktop.Sdk
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: kicad-startup
rename-appdata-file: org.kicad.kicad.metainfo.xml
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=x11

add-extensions:
  org.kicad.KiCad.Library:
    version: stable
    directory: extensions/Library
    autodelete: true
    no-autodownload: false
    subdirectories: true
    merge-dirs: template;symbols;footprints;3dmodels
  org.kicad.KiCad.ODBCDriver:
    version: stable
    directory: extensions/ODBCDriver
    autodelete: true
    no-autodownload: true
    subdirectories: true
    add-ld-path: lib
    merge-dirs: lib;template

cleanup:
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/wx
  - /lib64
  - /share/aclocal
  - /share/bakefile
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json

  - name: glm
    buildsystem: simple
    build-commands:
      - cp -r glm /app/include
    cleanup:
      - /include
    sources:
      - type: git
        url: https://github.com/g-truc/glm
        tag: 0.9.9.8
        commit: bf71a834948186f4097caa076cd2663c69a10e1e
        x-checker-data:
          type: git
          tag-pattern: ^([\d\.]+)$

  - name: libXmu
    cleanup:
      - /include
      - /share/doc
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxmu.git
        tag: libXmu-1.1.4
        commit: b29c739b577ee142877e69eb3fb07c7312d81557
        x-checker-data:
          type: git
          tag-pattern: ^libXmu-([\d\.]+)$

  - name: OCCT
    buildsystem: cmake-ninja
    cleanup:
      - /bin
      - /include
      - /share/doc
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_LIBRARY_TYPE=Shared
      - -DBUILD_Inspector=OFF
      - -DBUILD_DOC_Overview=OFF
      - -DBUILD_MODULE_ApplicationFramework=ON
      - -DBUILD_MODULE_DataExchange=ON
      - -DBUILD_MODULE_Draw=OFF
      - -DBUILD_MODULE_FoundationClasses=ON
      - -DBUILD_MODULE_ModelingAlgorithms=ON
      - -DBUILD_MODULE_ModelingData=ON
      - -DBUILD_MODULE_Visualization=ON
      - -DUSE_VTK=OFF
      - -DUSE_TBB=OFF
      - -DINSTALL_FREETYPE=OFF
      - -DINSTALL_SAMPLES=OFF
      - -DINSTALL_TEST_CASES=OFF
    sources:
      - type: git
        url: https://github.com/Open-Cascade-SAS/OCCT
        commit: b079fb9877ef64d4a8158a60fa157f59b096debb
        tag: V7_6_3
        x-checker-data:
          type: git
          tag-pattern: ^V([\d_]+)$

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=context,date_time,filesystem,iostreams,locale,program_options,regex,system,thread,test
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
    cleanup:
      - /include
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.81.0/source/boost_1_81_0.tar.gz
        sha256: 205666dea9f6a7cfed87c7a6dfbeb52a2c1b9de55712c9c1a87735d7181452b6
        x-checker-data:
          type: html
          url: https://www.boost.org/users/download/
          version-pattern: Version (\d+\.?\d+\.\d+)(?!\sbeta)|</a>$
          url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${version0}_${version1}_${version2}.tar.gz

  - name: wxWidgets
    cleanup:
      - /bin
      - /include
    config-opts:
      - --with-opengl
      - --disable-glcanvasegl
    sources:
      - type: archive
        url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.2.1/wxWidgets-3.2.2.1.tar.bz2
        sha256: dffcb6be71296fff4b7f8840eb1b510178f57aa2eb236b20da41182009242c02
        x-checker-data:
          type: html
          url: https://wxwidgets.org/downloads
          version-pattern: 'Latest Stable Release: ([\d\.]+)'
          url-template: https://github.com/wxWidgets/wxWidgets/releases/download/v$version/wxWidgets-$version.tar.bz2
      - type: script
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoconf -f -B build/autoconf_prepend-include

  - python3-wxPython.yml
  - python3-requests.yml

  - name: swig
    buildsystem: autotools
    cleanup:
      - /bin
      - /share
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-4.1.1/swig-4.1.1.tar.gz
        sha256: 2af08aced8fcd65cdb5cc62426768914bedc735b1c250325203716f78e39ac9b
        x-checker-data:
          type: html
          url: https://www.swig.org/download.html
          version-pattern: The latest release is <a href=".+">swig-([\d\.]+)</a>
          url-template: https://sourceforge.net/projects/swig/files/swig/swig-$version/swig-$version.tar.gz

  - name: ngspice
    cleanup:
      - /bin
      - /include
      - /share/man
    config-opts:
      - --disable-silent-rules
      - --enable-xspice
      - --enable-cider
      - --enable-openmp
      - --with-ngshared
    rm-configure: true
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/ngspice/ng-spice-rework/39/ngspice-39.tar.gz
        sha256: bf94e811eaad8aaf05821d036a9eb5f8a65d21d30e1cab12701885e09618d771
        x-checker-data:
          type: html
          url: https://ngspice.sourceforge.io/download.html
          version-pattern: <strong>ngspice-([\d]+)</strong>
          url-template: https://downloads.sourceforge.net/project/ngspice/ng-spice-rework/$version/ngspice-$version.tar.gz
      - type: script
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoconf -f -B build/autoconf_prepend-include

  - name: unixodbc
    sources:
      - type: git
        url: https://github.com/lurcher/unixODBC.git
        tag: 2.3.11
        commit: 6c8071b1bef4e4991e7b3023a1c1c712168a818e
        x-checker-data:
          type: git
          tag-pattern: ^([\d\.]+)$
      - type: script
        commands:
          - autoreconf -fi

  - name: kicad
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DGLEW_INCLUDE_DIR=/app/include/GL
      - -DOCC_INCLUDE_DIR=/app/include/opencascade
      - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.so
      - -DKICAD_BUILD_QA_TESTS=OFF
      - -DKICAD_BUILD_I18N=ON
      - -DKICAD_USE_EGL=OFF
      - -DKICAD_LIBRARY_DATA=/app/extensions/Library
    post-install:
      - install kicad-startup /app/bin/kicad-startup
      - install eeschema-startup /app/bin/eeschema-startup
      - install pcbnew-startup /app/bin/pcbnew-startup
      - install -d /app/extensions/ODBCDriver
      - install pip3 /app/bin/pip3.10
      - ln -s /app/bin/pip3.10 /app/bin/pip3
      - ln -s /app/bin/pip3 /app/bin/pip
      - install python /app/bin/python
      - >
        for f in $FLATPAK_DEST/share/applications/*.desktop; do
          desktop_name="$(basename $f)";
          desktop_app_name="${desktop_name%.desktop}";
          app_name="${desktop_app_name#org.kicad.}";
          if [ "$app_name" = "kicad" ]; then
            desktop-file-edit \
              --set-icon="${FLATPAK_ID}" \
              --set-key=Exec \
              --set-value="kicad-startup %f" \
              --set-key=X-Flatpak-RenamedFrom \
              --set-value="${desktop_name};" \
              "$f";
            mv $FLATPAK_DEST/share/applications/{org.kicad.kicad,$FLATPAK_ID}.desktop;
          else
            desktop-file-edit \
              --set-icon="${FLATPAK_ID}.${app_name}" \
              --set-key=X-Flatpak-RenamedFrom \
              --set-value="${desktop_name};" \
              "$f";
            if [[ "$app_name" =~ ^(eeschema|pcbnew)$ ]]; then
              desktop-file-edit \
                --set-key=Exec \
                --set-value="${app_name}-startup %f" \
                "$f";
            fi;
            mv $FLATPAK_DEST/share/applications/{org.kicad,$FLATPAK_ID}.${app_name}.desktop;
          fi;
        done;
        unset desktop_name desktop_app_name app_name
      - sed -i "s/\(application-x-kicad-.\+\)/$FLATPAK_ID.\1/" $FLATPAK_DEST/share/mime/packages/kicad-kicad.xml
      - mv $FLATPAK_DEST/share/mime/packages/{kicad,$FLATPAK_ID}-kicad.xml
      - mv $FLATPAK_DEST/share/mime/packages/{kicad,$FLATPAK_ID}-gerbers.xml
      - >
        cd $FLATPAK_DEST/share/icons/hicolor;
        for d in */{apps,mimetypes}; do
          for f in ${d}/*; do
            name="$(basename $f)";
            suffix="${name##*.}";
            if [[ "$name" == kicad.* ]]; then
              mv "$f" "${d}/${FLATPAK_ID}.${suffix}";
            else
              mv "$f" "${d}/${FLATPAK_ID}.${name}";
            fi;
          done;
        done;
        unset name suffix
    sources:
      - type: git
        url: https://gitlab.com/kicad/code/kicad.git
        commit: 3f5d3fa0c628567a944aa56a5d0fd03ac7809cf7
        tag: 7.0.1
        x-checker-data:
          type: git
          tag-pattern: ^([\d\.]+)$
          versions:
            <: 7.99.0
      - type: shell
        commands:
          - rm -rf .git/
          - sed -i 's/org\.kicad\.kicad/org.kicad.KiCad/g' resources/linux/metainfo/org.kicad.kicad.metainfo.xml.in
          - sed -i '86i<kudos><kudo>UserDocs</kudo></kudos>' resources/linux/metainfo/org.kicad.kicad.metainfo.xml.in
      - type: script
        dest-filename: pip3
        commands:
          - export PYTHONUSERBASE="$XDG_DATA_HOME/python"
          - export PATH="$XDG_DATA_HOME/python/bin":$PATH
          - exec /usr/bin/pip3 "$@"
      - type: script
        dest-filename: python
        commands:
          - export PYTHONUSERBASE="$XDG_DATA_HOME/python"
          - export PATH="$XDG_DATA_HOME/python/bin":$PATH
          - exec /usr/bin/python "$@"
      - type: script
        dest-filename: kicad-startup
        commands:
          - mkdir -p ${XDG_CONFIG_HOME}/unixodbc
          - export ODBCSYSINI=${XDG_CONFIG_HOME}/unixodbc
          # Remove config file, and recreate it from all available templates.
          # This handles uninstallation of ODBCDriver extensions.
          - rm -f ${ODBCSYSINI}/odbcinst.ini
          # Install available ODBC drivers
          - >
            for template in /app/extensions/ODBCDriver/template/*.ini; do
              test -f "$template" || continue;
              odbcinst -i -d -f "$template" >/dev/null;
            done
          - exec /app/bin/kicad "$@"
      - type: script
        dest-filename: eeschema-startup
        commands:
          - mkdir -p ${XDG_CONFIG_HOME}/unixodbc
          - export ODBCSYSINI=${XDG_CONFIG_HOME}/unixodbc
          # Remove config file, and recreate it from all available templates.
          # This handles uninstallation of ODBCDriver extensions.
          - rm -f ${ODBCSYSINI}/odbcinst.ini
          # Install available ODBC drivers
          - >
            for template in /app/extensions/ODBCDriver/template/*.ini; do
              test -f "$template" || continue;
              odbcinst -i -d -f "$template" >/dev/null;
            done
          - exec /app/bin/eeschema "$@"
      - type: script
        dest-filename: pcbnew-startup
        commands:
          - mkdir -p ${XDG_CONFIG_HOME}/unixodbc
          - export ODBCSYSINI=${XDG_CONFIG_HOME}/unixodbc
          # Remove config file, and recreate it from all available templates.
          # This handles uninstallation of ODBCDriver extensions.
          - rm -f ${ODBCSYSINI}/odbcinst.ini
          # Install available ODBC drivers
          - >
            for template in /app/extensions/ODBCDriver/template/*.ini; do
              test -f "$template" || continue;
              odbcinst -i -d -f "$template" >/dev/null;
            done
          - exec /app/bin/pcbnew "$@"
      - type: patch
        paths:
          - patches/0001-Support-subrelease-field-in-wxWidgets-cmake-detectio.patch
          - patches/0002-Relax-wxPython-version-mismatch-check-to-major.minor.patch

  - name: kicad-doc
    build-commands:
      # Only install HTML docs
      - find . -type f -name '*.pdf' -execdir rm {} \;
      - find . -type f -exec install -Dm644 "{}" "${FLATPAK_DEST}/{}" \;
    buildsystem: simple
    sources:
      - type: archive
        url: https://kicad-downloads.s3.cern.ch/docs/kicad-doc-7.0.1.tar.gz
        sha256: 04cad356fd19b46e70eaa6e3365d94c326e4237d80c09394208fd4662e756465
       
    
  


